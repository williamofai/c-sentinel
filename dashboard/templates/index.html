{% extends "base.html" %}

{% block title %}C-Sentinel Dashboard{% endblock %}

{% block header %}
<header class="bg-gray-800 border-b border-gray-700">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center">
                <i data-lucide="shield-check" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold">C-Sentinel</h1>
                <p class="text-xs text-gray-400">Semantic Observability</p>
            </div>
        </div>
        <div class="flex items-center space-x-6">
            <div id="stats" class="flex items-center space-x-6 text-sm">
                <div class="text-center">
                    <div id="stat-total" class="text-2xl font-bold">-</div>
                    <div class="text-gray-400">Hosts</div>
                </div>
                <div class="text-center">
                    <div id="stat-active" class="text-2xl font-bold text-emerald-400">-</div>
                    <div class="text-gray-400">Active</div>
                </div>
                <div class="text-center">
                    <div id="stat-critical" class="text-2xl font-bold text-red-400">-</div>
                    <div class="text-gray-400">Critical</div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                {% if session.role == 'admin' %}
                <a href="/admin/users" class="text-gray-400 hover:text-white flex items-center text-sm">
                    <i data-lucide="users" class="w-4 h-4 mr-1"></i>
                    Users
                </a>
                {% endif %}
                <a href="/profile" class="text-gray-400 hover:text-white flex items-center text-sm">
                    <i data-lucide="user" class="w-4 h-4 mr-1"></i>
                    {{ session.username }}
                </a>
                <a href="/logout" class="text-gray-400 hover:text-white flex items-center text-sm">
                    <i data-lucide="log-out" class="w-4 h-4 mr-1"></i>
                    Logout
                </a>
            </div>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Host Cards Container -->
    <div id="hosts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Loading state -->
        <div class="col-span-full text-center py-12 text-gray-500">
            <i data-lucide="loader-2" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
            <p>Loading hosts...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const REFRESH_INTERVAL = 30000;

    // Load hosts
    async function loadHosts() {
        try {
            const response = await fetch('/api/hosts');
            if (response.status === 401) {
                window.location.href = '/login';
                return;
            }
            const hosts = await response.json();
            
            const container = document.getElementById('hosts-container');
            
            if (hosts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i data-lucide="server-off" class="w-12 h-12 mx-auto mb-4 text-gray-600"></i>
                        <h3 class="text-lg font-semibold text-gray-400">No hosts yet</h3>
                        <p class="text-gray-500">Configure a sentinel agent to start monitoring</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = hosts.map(host => {
                const statusClass = `status-${host.status}`;
                const statusDot = host.status === 'ok' ? 'bg-emerald-400 pulse-dot' :
                                  host.status === 'warning' ? 'bg-yellow-400' :
                                  host.status === 'critical' ? 'bg-red-400' :
                                  'bg-gray-400';
                
                // Risk badge
                let riskBadge = '';
                if (host.audit_enabled && host.audit_risk_score !== null) {
                    const riskClass = `risk-${host.audit_risk_level || 'low'}`;
                    riskBadge = `
                        <div class="flex items-center justify-between p-2 rounded-lg ${riskClass}">
                            <span class="flex items-center text-sm">
                                <i data-lucide="shield" class="w-4 h-4 mr-1"></i>
                                Risk: ${(host.audit_risk_level || 'LOW').toUpperCase()}
                            </span>
                            <span class="font-bold">${host.audit_risk_score}</span>
                        </div>
                    `;
                }
                
                // Status icon
                let statusIcon = '';
                if (host.status === 'ok') {
                    statusIcon = '<i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>';
                } else if (host.status === 'warning') {
                    statusIcon = '<i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-400"></i>';
                } else if (host.status === 'critical') {
                    statusIcon = '<i data-lucide="alert-octagon" class="w-5 h-5 text-red-400"></i>';
                } else {
                    statusIcon = '<i data-lucide="clock" class="w-5 h-5 text-gray-400"></i>';
                }
                
                // Time ago
                const lastSeen = host.last_seen ? timeAgo(host.last_seen) : 'never';
                
                // Warnings
                let warnings = [];
                if (host.unusual_port_count > 0) {
                    warnings.push(`<span class="text-yellow-400"><i data-lucide="alert-triangle" class="w-3 h-3 inline"></i> ${host.unusual_port_count} unusual ports</span>`);
                }
                if (host.audit_brute_force) {
                    warnings.push(`<span class="text-red-400"><i data-lucide="alert-octagon" class="w-3 h-3 inline"></i> Brute force detected</span>`);
                }
                
                return `
                    <a href="/host/${host.hostname}" class="block bg-gray-800 rounded-lg border border-gray-700 p-6 hover:border-gray-600 transition-all card-hover">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center">
                                <span class="w-2 h-2 rounded-full ${statusDot} mr-3"></span>
                                <h3 class="font-semibold text-lg">${host.hostname}</h3>
                            </div>
                            ${statusIcon}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="bg-gray-900 rounded p-2">
                                <div class="text-gray-400 text-xs">Memory</div>
                                <div class="font-mono">${host.memory_percent ? host.memory_percent.toFixed(1) + '%' : '-'}</div>
                            </div>
                            <div class="bg-gray-900 rounded p-2">
                                <div class="text-gray-400 text-xs">Load</div>
                                <div class="font-mono">${host.load_1m ? host.load_1m.toFixed(2) : '-'}</div>
                            </div>
                            <div class="bg-gray-900 rounded p-2">
                                <div class="text-gray-400 text-xs">Processes</div>
                                <div class="font-mono">${host.process_count || '-'}</div>
                            </div>
                            <div class="bg-gray-900 rounded p-2">
                                <div class="text-gray-400 text-xs">Listeners</div>
                                <div class="font-mono">${host.listener_count || '-'}</div>
                            </div>
                        </div>
                        
                        ${riskBadge}
                        
                        ${warnings.length > 0 ? `
                            <div class="mt-3 text-xs space-y-1">
                                ${warnings.join('<br>')}
                            </div>
                        ` : ''}
                        
                        <div class="mt-4 flex justify-between text-xs text-gray-500">
                            <span>Uptime: ${host.uptime_days ? host.uptime_days.toFixed(1) + 'd' : '-'}</span>
                            <span>${lastSeen}</span>
                        </div>
                    </a>
                `;
            }).join('');
            
            lucide.createIcons();
            updateLastUpdated();
            
        } catch (error) {
            console.error('Failed to load hosts:', error);
        }
    }

    // Time ago helper
    function timeAgo(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        if (seconds < 60) return 'just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
        return Math.floor(seconds / 86400) + 'd ago';
    }

    // Load stats
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            if (response.status === 401) return;
            const stats = await response.json();
            
            document.getElementById('stat-total').textContent = stats.total_hosts;
            document.getElementById('stat-active').textContent = stats.active_hosts;
            document.getElementById('stat-critical').textContent = stats.critical_hosts;
            
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }

    // Initial load
    loadHosts();
    loadStats();

    // Auto-refresh
    setInterval(() => {
        loadHosts();
        loadStats();
    }, REFRESH_INTERVAL);
</script>
{% endblock %}
