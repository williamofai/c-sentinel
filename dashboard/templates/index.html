<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C-Sentinel Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .status-ok { color: #22c55e; }
        .status-warning { color: #eab308; }
        .status-critical { color: #ef4444; }
        .status-stale { color: #6b7280; }
        .status-unknown { color: #6b7280; }
        
        .bg-status-ok { background-color: #22c55e; }
        .bg-status-warning { background-color: #eab308; }
        .bg-status-critical { background-color: #ef4444; }
        .bg-status-stale { background-color: #6b7280; }
        
        .risk-low { color: #22c55e; }
        .risk-medium { color: #eab308; }
        .risk-high { color: #f97316; }
        .risk-critical { color: #ef4444; }
        
        .bg-risk-low { background-color: rgba(34, 197, 94, 0.2); }
        .bg-risk-medium { background-color: rgba(234, 179, 8, 0.2); }
        .bg-risk-high { background-color: rgba(249, 115, 22, 0.2); }
        .bg-risk-critical { background-color: rgba(239, 68, 68, 0.2); }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-dot { animation: pulse-dot 2s infinite; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center">
                    <i data-lucide="shield-check" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">C-Sentinel</h1>
                    <p class="text-xs text-gray-400">Semantic Observability</p>
                </div>
            </div>
            <div id="stats" class="flex items-center space-x-6 text-sm">
                <div class="text-center">
                    <div id="stat-total" class="text-2xl font-bold">-</div>
                    <div class="text-gray-400">Hosts</div>
                </div>
                <div class="text-center">
                    <div id="stat-active" class="text-2xl font-bold text-emerald-400">-</div>
                    <div class="text-gray-400">Active</div>
                </div>
                <div class="text-center">
                    <div id="stat-critical" class="text-2xl font-bold text-red-400">-</div>
                    <div class="text-gray-400">Critical</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Host Grid -->
        <div id="hosts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Host cards will be inserted here -->
            <div class="col-span-full text-center py-12 text-gray-500">
                <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
                <p>Loading hosts...</p>
            </div>
        </div>
        
        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
            <i data-lucide="server-off" class="w-16 h-16 mx-auto mb-4 text-gray-600"></i>
            <h2 class="text-xl font-semibold mb-2">No Hosts Reporting</h2>
            <p class="text-gray-400 mb-6">Configure your sentinel agents to report to this dashboard.</p>
            <div class="bg-gray-800 rounded-lg p-4 max-w-xl mx-auto text-left">
                <p class="text-sm text-gray-400 mb-2">Add to your sentinel cron or systemd:</p>
                <code class="text-xs text-emerald-400 block bg-gray-900 p-3 rounded">
                    sudo ./sentinel --json --network --audit | curl -X POST \<br>
                    &nbsp;&nbsp;-H "Content-Type: application/json" \<br>
                    &nbsp;&nbsp;-H "X-API-Key: YOUR_KEY" \<br>
                    &nbsp;&nbsp;-d @- https://sentinel.speytech.com/api/ingest
                </code>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 py-2 px-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between text-xs text-gray-500">
            <span>C-Sentinel v0.4.0</span>
            <span id="last-update">Last updated: -</span>
            <a href="https://github.com/williamofai/c-sentinel" class="hover:text-gray-300">
                <i data-lucide="github" class="w-4 h-4 inline"></i> GitHub
            </a>
        </div>
    </footer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Refresh interval (30 seconds)
        const REFRESH_INTERVAL = 30000;

        // Format relative time
        function timeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // Get status icon
        function statusIcon(status) {
            const icons = {
                'ok': 'check-circle',
                'warning': 'alert-triangle',
                'critical': 'alert-octagon',
                'stale': 'clock',
                'unknown': 'help-circle'
            };
            return icons[status] || 'help-circle';
        }
        
        // Get risk class
        function getRiskClass(level) {
            return level ? `risk-${level}` : 'risk-low';
        }
        
        function getBgRiskClass(level) {
            return level ? `bg-risk-${level}` : '';
        }

        // Create host card HTML
        function createHostCard(host) {
            const statusClass = `status-${host.status}`;
            const bgStatusClass = `bg-status-${host.status}`;
            
            // Risk badge HTML (only if audit is enabled)
            let riskBadge = '';
            if (host.audit_enabled && host.audit_risk_level) {
                const riskClass = getRiskClass(host.audit_risk_level);
                const bgRiskClass = getBgRiskClass(host.audit_risk_level);
                riskBadge = `
                    <div class="mt-2 flex items-center justify-between ${bgRiskClass} rounded px-2 py-1">
                        <span class="text-xs flex items-center ${riskClass}">
                            <i data-lucide="shield" class="w-3 h-3 mr-1"></i>
                            Risk: ${host.audit_risk_level.toUpperCase()}
                        </span>
                        <span class="text-xs font-mono ${riskClass}">${host.audit_risk_score || 0}</span>
                    </div>
                `;
            }
            
            // Brute force warning
            let bruteForceAlert = '';
            if (host.audit_brute_force) {
                bruteForceAlert = `
                    <div class="mt-1 text-xs text-red-400 flex items-center">
                        <i data-lucide="alert-octagon" class="w-3 h-3 mr-1"></i>
                        Brute force detected
                    </div>
                `;
            }
            
            return `
                <a href="/host/${host.hostname}" 
                   class="bg-gray-800 rounded-lg p-4 border border-gray-700 card-hover transition-all duration-200 block">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 rounded-full ${bgStatusClass} ${host.status === 'ok' ? 'pulse-dot' : ''}"></div>
                            <h3 class="font-semibold truncate">${host.hostname}</h3>
                        </div>
                        <i data-lucide="${statusIcon(host.status)}" class="w-5 h-5 ${statusClass}"></i>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="bg-gray-900 rounded p-2">
                            <div class="text-gray-400 text-xs">Memory</div>
                            <div class="font-mono">${host.memory_percent ? host.memory_percent.toFixed(1) + '%' : '-'}</div>
                        </div>
                        <div class="bg-gray-900 rounded p-2">
                            <div class="text-gray-400 text-xs">Load</div>
                            <div class="font-mono">${host.load_1m ? host.load_1m.toFixed(2) : '-'}</div>
                        </div>
                        <div class="bg-gray-900 rounded p-2">
                            <div class="text-gray-400 text-xs">Processes</div>
                            <div class="font-mono">${host.process_count || '-'}</div>
                        </div>
                        <div class="bg-gray-900 rounded p-2">
                            <div class="text-gray-400 text-xs">Listeners</div>
                            <div class="font-mono">${host.listener_count || '-'}</div>
                        </div>
                    </div>
                    
                    ${riskBadge}
                    
                    ${host.zombie_count > 0 ? `
                        <div class="mt-2 text-xs text-red-400 flex items-center">
                            <i data-lucide="skull" class="w-3 h-3 mr-1"></i>
                            ${host.zombie_count} zombie${host.zombie_count > 1 ? 's' : ''}
                        </div>
                    ` : ''}
                    
                    ${host.unusual_port_count > 0 ? `
                        <div class="mt-1 text-xs text-yellow-400 flex items-center">
                            <i data-lucide="alert-triangle" class="w-3 h-3 mr-1"></i>
                            ${host.unusual_port_count} unusual port${host.unusual_port_count > 1 ? 's' : ''}
                        </div>
                    ` : ''}
                    
                    ${bruteForceAlert}
                    
                    <div class="mt-3 text-xs text-gray-500 flex items-center justify-between">
                        <span>Uptime: ${host.uptime_days ? host.uptime_days.toFixed(1) + 'd' : '-'}</span>
                        <span>${host.last_seen ? timeAgo(host.last_seen) : 'never'}</span>
                    </div>
                </a>
            `;
        }

        // Load hosts
        async function loadHosts() {
            try {
                const response = await fetch('/api/hosts');
                const hosts = await response.json();
                
                const grid = document.getElementById('hosts-grid');
                const emptyState = document.getElementById('empty-state');
                
                if (hosts.length === 0) {
                    grid.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                } else {
                    grid.classList.remove('hidden');
                    emptyState.classList.add('hidden');
                    grid.innerHTML = hosts.map(createHostCard).join('');
                    lucide.createIcons();
                }
                
                // Update last refresh time
                document.getElementById('last-update').textContent = 
                    'Last updated: ' + new Date().toLocaleTimeString();
                    
            } catch (error) {
                console.error('Failed to load hosts:', error);
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('stat-total').textContent = stats.total_hosts;
                document.getElementById('stat-active').textContent = stats.active_hosts;
                document.getElementById('stat-critical').textContent = stats.critical_hosts;
                
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Initial load
        loadHosts();
        loadStats();

        // Auto-refresh
        setInterval(() => {
            loadHosts();
            loadStats();
        }, REFRESH_INTERVAL);
    </script>
</body>
</html>

